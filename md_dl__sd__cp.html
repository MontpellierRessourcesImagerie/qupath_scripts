<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>QuPath scripts: Segmentation with CellPose or StarDist</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="remixicon.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="icon.png"/></td>
  <td id="projectalign">
   <div id="projectname">QuPath scripts<span id="projectnumber">&#160;2024.06.30</span>
   </div>
   <div id="projectbrief">This repository gathers generalistic QuPath scripts covering a variety of tasks.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_dl__sd__cp.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Segmentation with CellPose or StarDist</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md0"></a> </p><div id="shields"> <img src="https://img.shields.io/badge/modality-FLUO-fc8803" alt="" class="modality fluo" class="inline"/> <img src="https://img.shields.io/badge/modality-IHC-fc8803" alt="" class="modality ihc" class="inline"/> <a href="https://github.com/MontpellierRessourcesImagerie/qupath_scripts/tree/main/deep-learning"><img src="https://img.shields.io/badge/code-Groovy-6495ED?logo=github" alt="" class="scripts" class="inline"/></a> <img src="https://img.shields.io/badge/qupath_version-0.5.1-ffee00" alt="" class="version" class="inline"/> <a href="https://github.com/MontpellierRessourcesImagerie/qupath_scripts/issues" style="vertical-align: top;"><img src="https://img.shields.io/github/issues/MontpellierRessourcesImagerie/qupath_scripts" alt="" class="inline"/></a> <img src="https://img.shields.io/badge/project-%232008-cd1818?logo=redmine" alt="" class="project" class="inline"/> <img src="https://img.shields.io/badge/status-in_dev-6495ED" alt="" class="status" class="inline"/> </div><hr  />
<p><img src="https://dev.mri.cnrs.fr/attachments/download/3429/sdcp-gui.gif" alt="Demo" class="inline"/></p>
<h1><a class="anchor" id="autotoc_md2"></a>
1. Functional specifications</h1>
<ul>
<li>The goal is to segment some objects (cells, nuclei, ...) on some 2D images (fluo or IHC) in QuPath using CellPose and/or StarDist.</li>
<li>We want to prevent the final users from having to edit the settings through some Groovy code.</li>
<li>We need to integrate this segmentation step into a script that can be run in batch mode ("Run for project").</li>
<li>For reproducibility purposes, a history of used settings is required.</li>
</ul>
<h1><a class="anchor" id="autotoc_md3"></a>
2. Install</h1>
<h2><a class="anchor" id="autotoc_md4"></a>
a. Install the scripts</h2>
<p>To use these scripts, you simply need to download all the <code>.groovy</code> files from this repository and place them in the <code>scripts</code> folder within your project's folder. If the <code>scripts</code> folder doesn't exist, create it. Your project's hierarchy should look like that:</p>
<div class="fragment"><div class="line">. 📁 my-project-folder/</div>
<div class="line">│    ├─ 📄 project.qpproj</div>
<div class="line">│    ├─ 📁 models/</div>
<div class="line">│    ├─ 📁 scripts/</div>
<div class="line">│    │     ├─ 📄 ask-dl-settings.groovy</div>
<div class="line">│    │     ├─ 📄 launch-cpsd.groovy</div>
<div class="line">│    │     ├─ 📄 segment-cellpose.groovy</div>
<div class="line">│    │     ├─ 📄 segment-stardist.groovy</div>
<div class="line">│    │     ├─ 📄 workflow.groovy</div>
</div><!-- fragment --><p>The <code>workflow.groovy</code> is just a basic template containing the skeleton of a script launching the segmentation process, it is not required.</p>
<h2><a class="anchor" id="autotoc_md5"></a>
b. Install CellPose</h2>
<p>Before being able to use CellPose from QuPath, don't forget to install the Python package <code>cellpose</code> with <code>pip</code>, and the bridge between QuPath and the CellPose server.</p>
<ul>
<li><a href="https://pypi.org/project/cellpose/">CellPose module</a></li>
<li><a href="https://github.com/BIOP/qupath-extension-cellpose">CellPose-QuPath bridge</a></li>
</ul>
<h2><a class="anchor" id="autotoc_md6"></a>
c. Install StarDist</h2>
<p>Before being able to use StarDist from QuPath, don't forget to install the bridge between QuPath and StarDist.</p>
<ul>
<li><a href="https://github.com/qupath/qupath-extension-stardist">StarDist-QuPath bridge</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md7"></a>
3. Use the settings prompt</h1>
<p>This script, which can be found under the name <code>ask-dl-settings</code> in Automate &gt; Project scripts, opens a prompt asking for the settings you want to run CellPose or StarDist with. It allows you to set up common settings for both CellPose and StarDist, giving you control in either case. One goal is to run our workflow in batch mode without a prompt appearing for every image. For this purpose, this script generates a JSON file with your chosen settings and saves it in the project's folder. Once you press "OK" on the window this script opens, your future runs of CellPose or StarDist will use these settings. Then, you can integrate the call to StarDist or CellPose in your workflow without worrying about the settings. You can reuse the generated file in any other project or even make it available for other users. The available settings are the following:</p>
<ul>
<li><code>Channel to segment</code>: In the case of fluorescence, it is the channel on which our objects are. Otherwise, for Brightfield (H-DAB, H&amp;E, ...), the three channels (red, green, and blue) are used.</li>
<li><code>Input annotation(s)</code>: Annotations in which our objects of interest are. If you choose a class name within the list, we will only segment the annotations having that class. Otherwise, you have some other choices:<ul>
<li><code>:: Active annotation</code>: Segment only within the active annotation.</li>
<li><code>:: Full image</code>: Creates a rectangle annotation over the whole image, makes it active, and runs the segmentation.</li>
<li><code>:: All annotations</code>: Will segment the objects within every annotation.</li>
</ul>
</li>
<li><code>Network</code>: The network to use is either CellPose or StarDist.</li>
<li><code>Model</code>: The model that we use for the selected network. The list includes the basic models for this network and the models within the "models" folder in the project's folder. If you have a custom model for StarDist, place it in <code>models/stardist</code>; for CellPose, in <code>models/cellpose</code>.</li>
<li><code>Normalization percentile</code>: If you choose the value α for this setting, the global image normalization will be between (α, 100.0-α).</li>
<li><code>Use cell expansion?</code>: In the case where we segment nuclei without cytoplasm staining, using this option will take each nucleus polygon and expand it on a certain distance to roughly estimate the area of the whole cell.</li>
<li><code>Expansion distance (µm)</code>: Distance on which the nuclei polygons will grow to turn them into cytoplasm polygons.</li>
<li><code>Classify results as</code>: Each segmented object will receive your chosen class here. If you leave it blank, the results won't be of any specific class.</li>
<li><code>Create annotations?</code>: It allows us to choose whether we should create annotations or detections.</li>
<li><code>Median cell diameter (µm)</code>: This parameter only affects CellPose. You can use the ruler in the viewer's lower-left corner to help estimate this size.</li>
<li><code>Save settings as</code>: Name that will receive the file containing the settings within the project's folder. It must only contain letters, numbers, dashes, and underscores.</li>
</ul>
<h1><a class="anchor" id="autotoc_md8"></a>
4. Use the launcher in a workflow</h1>
<h2><a class="anchor" id="autotoc_md9"></a>
a. What is it?</h2>
<p>The launcher will try to access and extract the settings from any <code>cnrs-mri-cia-cpsd.XXX.json</code> file that it will find in the project's directory. Then, it will pass them over to a worker and run it. Here, <code>XXX</code> corresponds to the name that you provided in the <code>Save settings as</code> field. The launcher is shared by both CellPose and StarDist; however, the workers are specialized.</p>
<h2><a class="anchor" id="autotoc_md10"></a>
b. How to use the launcher</h2>
<p>Usually, segmenting your objects is only a fragment of your project. You will certainly want to measure some features in what you segmented, count your objects or anything else. To execute your workflow, you will very likely want to create a script and run it for all the images in your project.</p>
<p>From this point, we consider that you found the correct settings with the settings prompt script.</p>
<p>To integrate the segmentation to your workflow, you can use either <code>workflow.groovy</code> or the following snippet:</p>
<div class="fragment"><div class="line"><span class="comment">// At the very begining of your script:</span></div>
<div class="line"><span class="keyword">import</span> groovy.lang.GroovyShell;</div>
<div class="line"><span class="keyword">import</span> groovy.lang.Binding;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// First step of your workflow:</span></div>
<div class="line"><span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Second step of your workflow:</span></div>
<div class="line"><span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Time to segment your objects</span></div>
<div class="line"><span class="comment">// Don&#39;t forget to replace &quot;XXX&quot; by the name of your settings file</span></div>
<div class="line">Binding binding = <span class="keyword">new</span> Binding();</div>
<div class="line">binding.setVariable(<span class="stringliteral">&quot;settings_name&quot;</span>, <span class="stringliteral">&quot;XXX&quot;</span>);</div>
<div class="line">GroovyShell shell = <span class="keyword">new</span> GroovyShell(this.<span class="keyword">class</span>.classLoader, binding);</div>
<div class="line">shell.evaluate(QP.getProject().getScripts().get(<span class="stringliteral">&quot;launch-cpsd&quot;</span>));</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Following steps of your workflow:</span></div>
<div class="line"><span class="comment">// ...</span></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md11"></a>
Tags</h1>
<p><span class="script_tag">CellPose</span> <span class="script_tag">StarDist</span> <span class="script_tag">Deep-learning</span> <span class="script_tag">Segmentation</span> <span class="script_tag">Nuclei</span> <span class="script_tag">Batch</span> <span class="script_tag">GUI</span> <span class="script_tag">Cells</span> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
